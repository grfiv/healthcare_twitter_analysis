<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="description" content="RESTful Interface to Healthcare Twitter Analysis MongoDB database">
    <meta name="author"      content="George Fisher">
    <meta name="viewport"    content="width=device-width,initial-scale=1">
 
    <title>RESTful Interface to Healthcare Twitter Analysis MongoDB database</title>

    <link href="css/jquery-ui.css"       rel="stylesheet">
    <link href="css/jQueryUI_inline.css" rel="stylesheet">
  </head>
  
  <body>
  
  <!-- ========================================================= -->
  <!-- =========================  TABS ========================= -->
  <!-- ========================================================= -->
  <h1 class="demoHeaders" 
      style='font-size:300%;text-align: center;'>
      RESTful Interface to Healthcare Twitter Analysis MongoDB database</h1>
      
  <div id="tabs">
      <ul>
          <li><a href="#tabs-1">Interface</a></li>
          <li><a href="#tabs-2">Instructions</a></li>
          <li><a href="#tabs-3">Choropleth</a></li>
          <li><a href="#tabs-4">Unused</a></li>
      </ul>
      
      <!-- ====================  INTERFACE ==================== -->
      <div id="tabs-1">
      <section class="query-input">
        <label for="query-text" style='font-size:200%;'>MongoDB Command-Line Query &nbsp;</label>
        <input type="text" id="query-text" name="query-text" 
               placeholder=" {$text: {$search: '#Sepsis'}}"
               style='width:450px;height:40px;font-size:200%'>
        <br>
        
        <label id="tooltip" for="query-limit" style='font-size:200%;' 
               title="Set this value to zero (0) to return every matching record">Enter the maximum to return &nbsp;&nbsp;&nbsp; </label>
        <input type="number" id="query-limit" name="query-limit" min="0" max="4000000"
               value="5" 
               style='width:150px;height:40px;font-size:200%;text-align: center;margin:5px 0 5px 0;'>
        <br>
        
        <button id="button" class="query-input-button"  style='margin: 15px 0 15px 400px;font-size:200%;border-radius: 15px;'>
                Click to send the query</button><br>
        <button id="button" class="display-first-button" style='margin: 15px 0 15px 455px;font-size:200%;border-radius: 15px; display: none;'>
                Display the first</button><br>
        <button id="button" class="display-all-button" style='margin: 15px 0 15px 485px;font-size:200%;border-radius: 15px; display: none;'>
                Display all</button>
      </section>
      
      <hr>
      
      <section id="query-response-section" style='display: none;'>
        <p id="query-str-display" style='font-size:150%;'>The query: <span></span></p>
        <p id="limit-display"     style='font-size:150%;'>Limited to: <span></span></p>
        <p id="numRet-display"    style='font-size:150%;'>Number returned: <span></span></p>
        
        <hr>
        
        <pre id="query-results" style='font-size:150%;'></pre>
      </section>
      
      
      </div> <!-- id="tabs-1"  -->
      
      <!-- ====================  INSTRUCTIONS ==================== -->
      <div id="tabs-2" style='font-size:150%;'>
      
      <p>These instructions assume the following:</p>
      <ul>
        <li>you have created a MongoDB database as follows<br>
         <span style='font-family:"Courier New"'>mongoimport -d HTA -c grf --file HTA_noduplicates.json</span><br>
         on an external hard drive, location <span style='font-family:"Courier New"'>E:\HTA</span><br>
         (the status report on the repo ... <a href="https://github.com/grfiv/healthcare_twitter_analysis">HTA repo</a>
         ... has detailed instructions).</li><br>
         
        <li>you have this webpage, <span style='font-family:"Courier New"'>HTAinterface.html</span> 
          and the Bottle Server, <span style='font-family:"Courier New"'>bottle_server.py</span><br>
          on the same external hard drive in location <span style='font-family:"Courier New"'>E:\HTA\RESTful Interface</span><br>
          with the supporting files in the structure shown in the repo.</li><br>
          
        <li>you are using the latest version of the Chrome browser; others may work, but only by luck.</li>
      </ul>
          
      <p>Obviously, these instructions apply to a Windows machine; Linux and Mac folks will have to adapt.</p>
        
      <ol>
        <li>Start the MongoDB Server using the database on the external drive<br>
          <ol>
            <li>Start a command window as Administrator</li>
            <li><span style='font-family:"Courier New"'>net stop MongoDB</span></li>
            <li><span style='font-family:"Courier New"'>mongod --dbpath "E:\HTA"</span></li>
          </ol>
        </li><br>
        
        <li>Start the Bottle HTTP Server<br>
          <ol>
            <li>Start another command window</li>
            <li><span style='font-family:"Courier New"'>e:</span></li>
            <li><span style='font-family:"Courier New"'>cd E:\HTA\RESTful Interface</span></li>
            <li><span style='font-family:"Courier New"'>python bottle_server.py</span></li>
          </ol>
        </li><br>
        
        <li>Using Chrome, load the interface web page<br>
          <span style='font-family:"Courier New"'>http://localhost:8082/</span></li>
        </li>
      </ol>
      
      <p>The interface is very simple: there are only two things you have to enter ...</p>
      <ul>
        <li>A MongoDB query in exactly the format used on the mongo command line</li>
        <li>A limit on the number of documents to return; set to zero (0) and the '_id's of all the matching documents will be returned</li>
      </ul>
      
      <p>At the moment you only see displayed the result of the query:</p>
      <ul>
        <li>a list of the '_id's that match, up to the limit ("id_list")</li>
        <li>the number in that list ("num")</li>
        <li>the first matching document ("example")</li>
      </ul>
      
      <p>My expectation is to enhance this system so that you can scroll through all the matching documents; 
         the plan is to make ajax requests behind the scenes as you scroll through so that an entire mass of data isn't sent down all at once, 
         storing the documents received so far in Chrome's IndexedDB local storage facility for quick random-access retrieval.</p>
         
      </div> <!-- id="tabs-2"  -->
      
      <!-- ====================  CHOROPLETH ==================== -->
      <div id="tabs-3">
        <section class="choropleth-section" style='font-size:150%; font-family:"Times New Roman",Garamond, serif'>
        <p>
          The link below brings up a D3.js choropleth map of US counties colored by unemployment rate 
          loaded from a tab-separated file.<br><br> The plan is to figure out how to use the FIPS data stored
          in the reverse-geo-tagged MongoDB documents for this project to search for any arbitrary 
          string in the database (words, hashtags, etc.) and plot their incidence on this same map
          in real time.<br><br>I have shown how to do background requests for data from the project's
          MongoDB database in the Interface tab and my thought is that this base technology will 
          allow all sorts of web-based analyses and visualizations.
        </p>
          <a href="choropleth.html">Choropleth</a>
        </section>
      </div> <!-- id="tabs-3"  -->
      
      <!-- ====================  tabs-4 ==================== -->
      <div id="tabs-4">
        <section class="tabs-4">
          <p>Currently unused</p>
        </section>
      </div> <!-- id="tabs-4"  -->
  </div>
  
  <!-- For all you load-sequence fanatics, I'll get around to making the JavaScript load asynchronously when I'm closer to finished. -->
  
  <script src="js/jquery-2.1.1.min.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script>
  // ==============
  // jQuery UI code
  // ==============
  $( "#tabs" ).tabs();
  $( "#tooltip" ).tooltip();
  $( "#button" ).button();
  $( "#radioset" ).buttonset();
  
  // =========
  // Utilities
  // =========
  function isNonNegInt(n) {
    // is n a non-negative integer?
    // (+n coerces n to a number) 
    if ($.isNumeric(n) && (+n)%1 == 0 && (+n) >= 0) { return true; }
    return false;
  }
  
  function refreshPage() {
    // reload the page 
    location.reload();
  }
  
  // holds the list of _id's returned
  var id_list;
  
  // ====================================================
  // when the 'Click to send the query' button is clicked
  // ====================================================
  $( ".query-input-button" ).on('click', function() {
  
    // get the query and limit
    // -----------------------
    var query_str = $( "#query-text" ).val();
    if (query_str === "") {
      query_str = "{$text: {$search: '#Sepsis'}}";
    }
    
    var limit = $( "#query-limit" ).val();
    if (!isNonNegInt(limit)) { 
      limit = "5"; 
      $( "#query-limit" ).val(limit)
      }
    
    // convert the query string to object form (eval)
    // and then JSON stringify it for transmission to server
    // -----------------------------------------------------
    query_str = JSON.stringify(eval('(' + query_str + ')'));
    
    // display the query and limit on the page
    // ---------------------------------------
    $("#query-response-section").show();
    $("#query-str-display").find("span").text(query_str);
    $("#limit-display").find("span").text(limit);
    
    // send the query to the server
    // ----------------------------
    var request = $.ajax({
      url:         "http://localhost:8082/query/" + limit,
      type:        "POST",
      data:        query_str, 
      dataType:    "json",
      contentType: "application/json"
    });
    
    // if the request is successful
    // ----------------------------
    request.done(function( response ) {
        console.log( response );
        
        // save the list of '_id's returned
        id_list = response['id_list'];
        
        // display the response
        var jsonPretty = JSON.stringify(response, null, '\t');
        $( "pre" ).text(jsonPretty);
        
        // display the number of matches returned
        $( "#numRet-display" ).find("span").text(response['num']);
        
        // show or hide the 'Display the first' and 'Display all' buttons
        if (response['num'] > 0) {
          $( ".display-first-button" ).show();
          $( ".display-all-button" ).show();
        } else {
          $( ".display-first-button" ).hide();
          $( ".display-all-button" ).hide();
        }
    });
    
    // if the request fails
    // --------------------
    request.fail(function( jqXHR, textStatus ) {
      alert( "Request failed: " + textStatus );
    });
  
  }); // <=== $( ".query-input-button" ).on('click'
  
  // ==============================================
  // when the 'Display the first' button is clicked
  // ==============================================
  $( ".display-first-button" ).on('click', function() {
  
    // pull the ObjectId string of the first '_id' returned
    var first_id = id_list[0]['_id']['$oid'];
    
    // send the query to the server
    // ----------------------------
    var request = $.getJSON( "http://localhost:8082/findone/" + first_id );
    
    // if the request is successful
    // ----------------------------
    request.done(function( response ) {
        console.log( response );
        
        var first_tweet = response['first_tweet'];
        // display the response
        var jsonPretty = JSON.stringify(first_tweet, null, '\t');
        $( "pre" ).text(jsonPretty);
    });
    
    // if the request fails
    // --------------------
    request.fail(function( jqXHR, textStatus ) {
      alert( "Request failed: " + textStatus );
    });
  
  });  // <=== $( ".display-first-button" ).on('click'
  
  // ========================================
  // when the 'Display all' button is clicked
  // ========================================
  $( ".display-all-button" ).on('click', function() {
  
    // pull the ObjectId strings
    var list_ids = [];
    id_list.forEach(function(entry) {
      list_ids.push(entry['_id']['$oid']);
    });
    
    // send the query to the server
    // ----------------------------
    var request = $.getJSON( "http://localhost:8082/find/" + list_ids );
    
    // if the request is successful
    // ----------------------------
    request.done(function( response ) {
        console.log( response );
        
        // display the response
        var jsonPretty = JSON.stringify(response, null, '\t');
        $( "pre" ).text(jsonPretty);
    });
    
    // if the request fails
    // --------------------
    request.fail(function( jqXHR, textStatus ) {
      alert( "Request failed: " + textStatus );
    });
    
  });  // <=== $( ".display-all-button" ).on('click'
  </script>
  
  </body>
</html>